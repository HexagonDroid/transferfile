<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dynamic iOS App Installer</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    padding: 20px; background: #f7f7f7; text-align: center;
  }
  #ipForm {
    margin-bottom: 20px;
  }
  input[type="text"] {
    font-size: 1.2em;
    padding: 8px;
    width: 250px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    font-size: 1.2em;
    padding: 8px 15px;
    border: none;
    background: #007aff;
    color: white;
    border-radius: 5px;
    margin-left: 10px;
  }
  #status {
    margin: 15px 0;
  }
  #appList {
    margin-top: 30px;
    position: relative;
  }
  .appEntry {
    display: inline-block;
    margin: 15px;
    text-align: center;
  }
  .appEntry img {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    cursor: pointer;
  }
  a {
    color: #007aff;
    text-decoration: none;
    cursor: pointer;
    display: block;
    margin-top: 8px;
  }
  a:hover {
    text-decoration: underline;
  }

  /* Install Profile button top-right */
  #installProfileBtn {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.9em;
    padding: 6px 12px;
    background: #007aff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>iOS App Installer</h1>

<div id="ipForm">
  <label for="ipInput">Enter the hotspot IP address (e.g. 192.168.44.1): </label>
  <input type="text" id="ipInput" placeholder="192.168.x.x" />
  <button onclick="startSetup()">Start</button>
</div>

<div id="status"></div>

<div id="appList" style="display:none; position: relative;">
  <button id="installProfileBtn" style="display:none;" onclick="installProfile()">Install Profile</button>
</div>

<script>
const DEFAULT_IP = "192.168.44.1";
let userIP = null;
let pollInterval = null;

function startSetup() {
  const ip = document.getElementById('ipInput').value.trim();
  if (!ip) {
    alert('Please enter a valid IP address');
    return;
  }
  const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
  if (!ipRegex.test(ip)) {
    alert('Invalid IP format');
    return;
  }
  userIP = ip;

  // Hide input, show status and apps list + show Install Profile button
  document.getElementById('ipForm').style.display = 'none';
  document.getElementById('status').innerText = 'Checking for apps...';
  document.getElementById('appList').style.display = 'block';
  document.getElementById('installProfileBtn').style.display = 'inline-block';

  // Start polling apps
  pollApps();
  pollInterval = setInterval(pollApps, 5000);
}

async function pollApps() {
  try {
    const url = `https://${userIP}:8080/files/apps/`;
    let res = await fetch(url, {mode: 'cors'});
    if (!res.ok) throw new Error('Apps directory not accessible');
    let text = await res.text();

    // Try parse JSON (if server sends JSON file list)
    let apps = [];
    try {
      apps = JSON.parse(text);
      if (!Array.isArray(apps)) apps = [];
    } catch {
      apps = parseAppsFromHTML(text);
    }

    // Clean up apps list:
    apps = apps
      .map(name => name.trim())
      .filter(name => name !== "" && name !== "/files" && name !== "/files/apps")  // Remove unwanted entries
      .map(name => name.startsWith("./") ? name.substring(2) : name);             // Remove leading "./"

    if (apps.length === 0) {
      document.getElementById('status').innerText = 'No apps available yet. Retrying...';
      document.getElementById('appList').innerHTML = '';
      return;
    }

    document.getElementById('status').innerText = 'Select an app to install:';
    renderAppList(apps);
    clearInterval(pollInterval);

  } catch(e) {
    document.getElementById('status').innerText = 'Waiting for apps to be available...';
    document.getElementById('appList').innerHTML = '';
  }
}

function parseAppsFromHTML(htmlText) {
  let parser = new DOMParser();
  let doc = parser.parseFromString(htmlText, 'text/html');
  let anchors = Array.from(doc.querySelectorAll('a[href$="/"]'));
  return anchors
    .map(a => a.getAttribute('href').replace(/\/$/, ''))
    .filter(name => name && name !== '..');
}

function renderAppList(apps) {
  const appListDiv = document.getElementById('appList');
  appListDiv.innerHTML = '';
  
  // Add the Install Profile button back since we cleared innerHTML
  const installBtn = document.getElementById('installProfileBtn');
  appListDiv.appendChild(installBtn);

  apps.forEach(appName => {
    const iconURL = `https://${userIP}:8080/files/apps/${appName}/${appName}.png`;

    const div = document.createElement('div');
    div.className = 'appEntry';

    const img = document.createElement('img');
    img.src = iconURL;
    img.alt = appName + ' icon';
    img.onerror = () => { img.style.display = 'none'; };
    img.onclick = () => installApp(appName);

    const a = document.createElement('a');
    a.textContent = appName;
    a.href = '#';
    a.title = `Install ${appName}`;
    a.onclick = (e) => {
      e.preventDefault();
      installApp(appName);
    };

    div.appendChild(img);
    div.appendChild(a);
    appListDiv.appendChild(div);
  });
}

function installApp(appName) {
  const plistURL = `https://${userIP}:8080/files/real_plists/${appName}.plist`;
  const itmsURL = `itms-services://?action=download-manifest&url=${encodeURIComponent(plistURL)}`;
  window.location.href = itmsURL;
}

function installProfile() {
  const profileURL = `https://${userIP}:8080/files/real_plists/rootca_profile.mobileconfig`;
  window.open(profileURL, '_blank');
}
</script>

</body>
</html>
